<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Pagos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f5f6fa;
    }
    .card {
      margin-bottom: 1.5rem;
    }
    nav a {
      margin-right: 10px;
    }
    .table-actions button {
      margin-right: 5px;
    }
  </style>
</head>
<body>
<div class="container mt-4">
  <h2 class="text-center mb-4">Sistema de Pagos</h2>

  <nav class="mb-4">
    <a href="#" class="btn btn-outline-primary" onclick="mostrarVista('vistaConcepto')">Crear Concepto</a>
    <a href="#" class="btn btn-outline-info" onclick="mostrarVista('vistaListaConceptos')">Ver Conceptos</a>
    <a href="#" class="btn btn-outline-success" onclick="mostrarVista('vistaPago')">Registrar Pago</a>
    <a href="#" class="btn btn-outline-secondary" onclick="mostrarVista('vistaListado')">Listado de Pagos</a>
  </nav>

  <!-- Vista: Crear concepto de pago -->
  <div id="vistaConcepto" class="card">
    <div class="card-header">Crear concepto de pago</div>
    <div class="card-body">
      <form id="formConcepto">
        <div class="mb-3">
          <label for="concepto" class="form-label">Nombre del concepto</label>
          <input type="text" class="form-control" id="concepto" name="concepto" required>
        </div>
        <div class="mb-3">
          <label for="monto" class="form-label">Monto (S/)</label>
          <input type="number" class="form-control" id="monto" name="monto" step="0.01" required>
        </div>
        <button type="submit" class="btn btn-primary">Guardar concepto</button>
      </form>
    </div>
  </div>

  <!-- Vista: Listado de conceptos -->
  <div id="vistaListaConceptos" class="card" style="display: none;">
    <div class="card-header">Conceptos de Pago</div>
    <div class="card-body">
      <table class="table table-bordered" id="tablaConceptos">
        <thead>
          <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>Monto</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Vista: Registrar pago de persona -->
  <div id="vistaPago" class="card" style="display: none;">
    <div class="card-header">Registrar pago de persona</div>
    <div class="card-body">
      <form id="formPago">
        <div class="mb-3">
          <label for="persona" class="form-label">Persona</label>
          <select class="form-select" id="persona" name="persona" required></select>
        </div>
        <div class="mb-3">
          <label for="conceptoPago" class="form-label">Concepto</label>
          <select class="form-select" id="conceptoPago" name="conceptoPago" required></select>
        </div>
        <div class="mb-3">
          <label for="montoPagado" class="form-label">Monto pagado (S/)</label>
          <input type="number" class="form-control" id="montoPagado" name="montoPagado" step="0.01" required>
        </div>
        <div class="mb-3">
          <label for="modoPago" class="form-label">Modo de pago</label>
          <select class="form-select" id="modoPago" name="modoPago" required>
            <option value="Efectivo">Efectivo</option>
            <option value="Transferencia">Transferencia</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="fechaPago" class="form-label">Fecha de pago</label>
          <input type="date" class="form-control" id="fechaPago" name="fechaPago" required>
        </div>
        <button type="submit" class="btn btn-success">Registrar pago</button>
      </form>
    </div>
  </div>

  <!-- Vista: Listado de pagos -->
  <div id="vistaListado" class="card" style="display: none;">
    <div class="card-header">Listado de pagos</div>
    <div class="card-body">
      <form id="formFiltro" class="row g-3 mb-3">
        <div class="col-md-4">
          <label for="filtroPersona" class="form-label">Persona</label>
          <select class="form-select" id="filtroPersona" name="persona"></select>
        </div>
        <div class="col-md-4">
          <label for="filtroConcepto" class="form-label">Concepto</label>
          <select class="form-select" id="filtroConcepto" name="concepto"></select>
        </div>
        <div class="col-md-4">
          <label for="filtroFecha" class="form-label">Fecha de pago</label>
          <input type="date" class="form-control" id="filtroFecha" name="fecha">
        </div>
        <div class="col-12">
          <button type="submit" class="btn btn-secondary">Filtrar</button>
        </div>
      </form>
      <form id="formExportar" method="POST" action="api/exportar_excel.php" target="_blank" style="display:inline;">
        <input type="hidden" name="persona">
        <input type="hidden" name="concepto">
        <input type="hidden" name="fecha">
        <button class="btn btn-success" type="submit">Exportar a Excel</button>
      </form>
      <div id="resultadoPagos"></div>
    </div>
  </div>
</div>

<script>
  function mostrarVista(id) {
    ['vistaConcepto', 'vistaPago', 'vistaListado', 'vistaListaConceptos'].forEach(v => {
      document.getElementById(v).style.display = 'none';
    });
    document.getElementById(id).style.display = 'block';

    if (id === 'vistaListaConceptos') cargarListaConceptos();
  }

  function cargarPersonas(selectId) {
    fetch("api/listar_personas.php")
      .then(res => res.json())
      .then(data => {
        const select = document.getElementById(selectId);
        select.innerHTML = '<option value="">-- Todas --</option>' + data.map(p => `<option value="${p.id}">${p.paterno} ${p.materno}, ${p.nombre}</option>`).join("");
      });
  }

  function cargarConceptos(selectId) {
    fetch("api/listar_conceptos.php")
      .then(res => res.json())
      .then(data => {
        const select = document.getElementById(selectId);
        select.innerHTML = '<option value="">-- Todos --</option>' + data.map(c => `<option value="${c.id}">${c.nombre} (S/ ${c.monto})</option>`).join("");
      });
  }

  function cargarListaConceptos() {
    fetch("api/listar_conceptos.php")
      .then(res => res.json())
      .then(data => {
        const tbody = document.querySelector("#tablaConceptos tbody");
        tbody.innerHTML = data.map(c => `
          <tr>
            <td>${c.id}</td>
            <td>${c.nombre}</td>
            <td>S/ ${c.monto}</td>
            <td class="table-actions">
              <button class="btn btn-danger btn-sm" onclick="eliminarConcepto(${c.id})">Eliminar</button>
            </td>
          </tr>
        `).join("");
      });
  }

  function eliminarConcepto(id) {
    if (confirm("¿Seguro que deseas eliminar este concepto?")) {
      fetch(`api/eliminar_concepto.php?id=${id}`)
        .then(res => res.text())
        .then(msg => {
          alert(msg);
          cargarListaConceptos();
        });
    }
  }

  function eliminarPago(id) {
    if (confirm("¿Seguro que deseas eliminar este pago?")) {
      fetch(`api/eliminar_pago.php?id=${id}`)
        .then(res => res.text())
        .then(msg => {
          alert(msg);
          document.getElementById("formFiltro").dispatchEvent(new Event("submit"));
        });
    }
  }

  function limpiarFormularioPago() {
    const form = document.getElementById("formPago");
    if (form) {
        form.reset();
        form.querySelector("#persona").selectedIndex = 0;
        form.querySelector("#conceptoPago").selectedIndex = 0;
        form.querySelector("#modoPago").selectedIndex = 0;
        form.querySelector("#fechaPago").value = "";
    }
  }


  document.addEventListener("DOMContentLoaded", () => {
    cargarPersonas("persona");
    cargarPersonas("filtroPersona");
    cargarConceptos("conceptoPago");
    cargarConceptos("filtroConcepto");

    document.getElementById("formConcepto").addEventListener("submit", function(e) {
      e.preventDefault();
      fetch("api/guardar_concepto.php", {
        method: "POST",
        body: new FormData(this)
      }).then(res => res.text()).then(alert);
    });

    document.getElementById("formPago").addEventListener("submit", function(e) {
      e.preventDefault();
      fetch("api/registrar_pago.php", {
        method: "POST",
        body: new FormData(this)
      }).then(res => res.text())
      .then(msg => {
        alert(msg);
        limpiarFormularioPago();
      });
    });

    document.getElementById("formFiltro").addEventListener("submit", function(e) {
      e.preventDefault();
      const fd = new FormData(this);
      fetch("api/filtrar_pagos.php", {
        method: "POST",
        body: fd
      })
      .then(res => res.text())
      .then(html => document.getElementById("resultadoPagos").innerHTML = html);
    });

    document.getElementById("formFiltro").addEventListener("submit", function () {
        // Copiar filtros al formExportar
        const filtros = ["persona", "concepto", "fecha"];
        filtros.forEach(id => {
            document.querySelector(`#formExportar [name='${id}']`).value = document.getElementById("filtro" + id.charAt(0).toUpperCase() + id.slice(1)).value;
        });
        });
    });
</script>
</body>
</html>
